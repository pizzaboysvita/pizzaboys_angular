<div class="row">
  <div class="col-sm-12">
    <app-card [body]="true">
      <div body
        class="row row-cols-xl-12 row-cols-md-5 row-cols-sm-3 row-cols-2 g-sm-3 g-2 media-library-sec ratio_landscape">
        <div class="input-box search-icon">
          <i class="ri-search-line"></i>
          <input class="search-box" type="search" placeholder="What are you looking for?" [(ngModel)]="searchText"
            name="search" (keyup)="searchTerm(searchText)"
            style="flex: 1; border: none; outline: none; background: transparent;" />
        </div>

        <div class="w-100">
          <div class="mb-4 position-relative">
            <h5 class="mb-3 fw-bold">Categories</h5>
            <button class="scroll-btn start" (click)="scrollLeft()">‹</button>
            <button class="scroll-btn end" (click)="scrollRight()">›</button>

            <div #scrollContainer class="d-flex gap-3 pb-2 px-3" style="scroll-behavior: smooth; overflow: hidden;">
              @for (category of categoriesList; track category.category_id) {
              <div class="d-flex align-items-center px-3 py-2 bg-white shadow-sm rounded-4 flex-shrink-0"
                (click)="selectCategory(category)" [ngClass]="{
                                    'border-primary border-2': selectedCategory === category
                                }" style="min-width: 120px;">
                <img [src]="category.category_image" alt="{{ category.name }}"
                  style="width: 25px; height: 25px; border-radius: 50%;" class="me-3" />
                <div>
                  <div class="fw-semibold">{{ category.name }}</div>
                  <div class="text-muted small">
                    {{ category.dishes.length }} items
                  </div>
                </div>
              </div>
              }
            </div>
          </div>

          <div class="row gx-2 gy-0">
            @for (item of dishList; track item.dish_id) {
            <div class="col-md-3" style="margin-top: -15px !important;">
              <div class="card flex-row align-items-center p-2 shadow-sm h-100" style="height: 110px !important;"
                (click)="openIngredientsPopup(item)">
                <img [src]="item.dish_image" alt="{{ item.dish_name }}" class="img-thumbnail me-3"
                  style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" />

                <div class="flex-grow-1">
                  <h6 class="mb-1">{{ item.dish_name }}</h6>
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">${{ item.dish_price }}</span>
                  </div>
                  <div class="d-flex align-items-end gap-1 quantity-controls" style="justify-content: end;">
                    <button *ngIf="!item.quantity || item.quantity === 0" class="qty-btn"
                      (click)="addItem(item); $event.stopPropagation()">
                      +
                    </button>

                    <ng-container *ngIf="item.quantity as currentQuantity">
                      <ng-container *ngIf="currentQuantity > 0">
                        <button class="qty-btn" (click)="decreaseItem(item); $event.stopPropagation()">
                          -
                        </button>
                        <span class="qty-count">{{ currentQuantity }}</span>
                        <button class="qty-btn" (click)="increaseItem(item); $event.stopPropagation()">
                          +
                        </button>
                      </ng-container>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
            }
          </div>
        </div>
      </div>
    </app-card>
  </div>
</div>

@if (showPopup) {
<div class="modal fade show d-block modal-overlay" tabindex="-1" role="dialog" aria-labelledby="ingredientsModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" #modalContent>
      <div class="modal-header">
        <h4 class="modal-title w-100" id="ingredientsModalLabel">
          <span class="fw-bold fs-4">{{ selectedItem.display_name }}</span>
          <span class="float-end fw-bold fs-4">${{ selectedItem.dish_price
            }}</span>
        </h4>
      </div>

      <div class="modal-body">
        <div class="option-section">
          <div class="option-header" [ngClass]="{'expanded': expandedIndex === 0}" (click)="toggleExpand(0)">
            <div class="d-flex flex-column">
              <span class="fw-semibold option-section-title">Base</span>
              <small class="text-muted option-section-subtitle">Select one (Required)</small>
            </div>
            <i class="material-icons">{{ expandedIndex === 0 ? 'expand_less' : 'expand_more' }}</i>
          </div>
          @if (expandedIndex === 0) {
          <div class="option-list">
            @for (baseOption of selectedItem.base.options; track baseOption.name)
            {
            <div class="option-item">
              <span class="fw-normal option-name-text">{{ baseOption.name }}</span>
              <div class="option-price-toggle-group">
                @if (baseOption.price > 0) {
                <span class="price-display me-2">+${{ baseOption.price | number:'1.2-2' }}</span>
                }
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input" type="radio" [name]="'baseOptionGroup'"
                    [checked]="baseOption.selected" (change)="selectBase(baseOption)" />
                </div>
              </div>
            </div>
            } @empty {
            <p class="text-muted text-center py-2">No base options available.</p>
            }
          </div>
          }
        </div>

        <div class="option-section">
          <div class="option-header" [ngClass]="{'expanded': expandedIndex === 1}" (click)="toggleExpand(1)">
            <div class="d-flex flex-column">
              <span class="fw-semibold option-section-title">Extra Toppings</span>
              <small class="text-muted option-section-subtitle">Select up to
                {{ selectedItem.extraToppings.maxSelect || 0 }} (Optional)</small>
            </div>
            <i class="material-icons">{{ expandedIndex === 1 ? 'expand_less' : 'expand_more' }}</i>
          </div>
          @if (expandedIndex === 1) {
          <div class="option-list">
            @for (topping of selectedItem.extraToppings.options; track topping.name)
            {
            <div class="option-item">
              <span class="fw-normal option-name-text">{{ topping.name }}</span>
              <div class="option-price-toggle-group">
                @if (topping.price !== undefined && topping.price > 0) {
                <span class="price-display me-2">+${{ topping.price | number:'1.2-2' }}</span>
                }
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="topping.selected" [disabled]="
                                            (selectedItem.extraToppings.selectedCount || 0) >=
                                                (selectedItem.extraToppings.maxSelect || 0) &&
                                                !topping.selected
                                        " (change)="toggleTopping(topping)" />
                </div>
              </div>
            </div>
            } @empty {
            <p class="text-muted text-center py-2">No extra toppings available.</p>
            }
          </div>
          }
        </div>

        <div class="option-section">
          <div class="option-header" [ngClass]="{'expanded': expandedIndex === 2}" (click)="toggleExpand(2)">
            <div class="d-flex flex-column">
              <span class="fw-semibold option-section-title">Extra Swirls / Sauces</span>
              <small class="text-muted option-section-subtitle">Select up to
                {{ selectedItem.extraSwirlsSauces.maxSelect || 0 }}
                (Optional)</small>
            </div>
            <i class="material-icons">{{ expandedIndex === 2 ? 'expand_less' : 'expand_more' }}</i>
          </div>
          @if (expandedIndex === 2) {
          <div class="option-list">
            @for (sauce of selectedItem.extraSwirlsSauces.options; track sauce.name)
            {
            <div class="option-item">
              <span class="fw-normal option-name-text">{{ sauce.name }}</span>
              <div class="option-price-toggle-group">
                @if (sauce.price !== undefined && sauce.price > 0) {
                <span class="price-display me-2">+${{ sauce.price | number:'1.2-2' }}</span>
                }
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="sauce.selected" [disabled]="
                                            (selectedItem.extraSwirlsSauces.selectedCount || 0) >=
                                                (selectedItem.extraSwirlsSauces.maxSelect || 0) &&
                                                !sauce.selected
                                        " (change)="toggleSauce(sauce)" />
                </div>
              </div>
            </div>
            } @empty {
            <p class="text-muted text-center py-2">No extra swirls/sauces available.</p>
            }
          </div>
          }
        </div>

        <div class="option-section">
          <div class="option-header" [ngClass]="{'expanded': expandedIndex === 3}" (click)="toggleExpand(3)">
            <div class="d-flex flex-column">
              <span class="fw-semibold option-section-title">Ingredients</span>
              <small class="text-muted option-section-subtitle">Un-check to remove</small>
            </div>
            <i class="material-icons">{{ expandedIndex === 3 ? 'expand_less' : 'expand_more' }}</i>
          </div>
          @if (expandedIndex === 3) {
          <div class="option-list">
            @for (ingredient of selectedItem.ingredients.options; track ingredient.name) {
            <div class="option-item">
              <span class="fw-normal option-name-text">{{ ingredient.name }}</span>
              <div class="option-price-toggle-group">
                @if (ingredient.price !== undefined && ingredient.price > 0) {
                <span class="price-display me-2">+${{ ingredient.price | number:'1.2-2' }}</span>
                }
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="ingredient.selected" />
                </div>
              </div>
            </div>
            } @empty {
            <p class="text-muted text-center py-2">No ingredients listed.</p>
            }
          </div>
          }
        </div>

        <div class="notes-section">
          <label class="form-label fw-semibold mb-1 option-section-title">
            Notes
          </label>
          <textarea class="form-control" [(ngModel)]="selectedItem.notes" placeholder="Add a note..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <div class="input-group quantity-control">
          <button class="btn btn-outline-warning" (click)="decreaseQty()">
            −
          </button>
          <input type="text" class="form-control text-center quantity-input" [value]="quantity" readonly />
          <button class="btn btn-outline-warning" (click)="increaseQty()">
            +
          </button>
          <button class="btn btn-outline-secondary ms-2">
            <i class="ri-file-copy-line"></i>
          </button>
          <button class="btn btn-outline-secondary">
            <i class="ri-price-tag-3-line"></i>
          </button>
          <button class="btn btn-warning text-white fw-bold px-4" (click)="addDish()">
          ADD DISH
        </button>
        </div>
        
      </div>
    </div>
  </div>
</div>
}